{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/your-org/authz-service/schemas/services.schema.json",
  "$ref": "#/$defs/services_config",
  "$defs": {
    "audit_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable audit logging for authorization decisions.",
          "default": true
        },
        "events": {
          "items": {
            "type": "string",
            "examples": [
              "AUTHZ_DECISION",
              "TOKEN_VALIDATED"
            ]
          },
          "type": "array",
          "description": "Event types to audit.",
          "default": [
            "[AUTHZ_DECISION]"
          ]
        },
        "export": {
          "$ref": "#/$defs/export_config",
          "description": "Audit log export configuration."
        },
        "enrichment": {
          "$ref": "#/$defs/enrich_config",
          "description": "Audit log enrichment settings."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "builtin_policy_config": {
      "properties": {
        "rules_path": {
          "type": "string",
          "description": "Path to YAML rules file for builtin engine.",
          "default": "/etc/authz/rules.yaml"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "cache_config": {
      "properties": {
        "l1": {
          "$ref": "#/$defs/l1cache_config",
          "description": "L1 (in-memory) cache for lowest latency."
        },
        "l2": {
          "$ref": "#/$defs/l2cache_config",
          "description": "L2 (distributed) cache for shared caching across instances."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "cache_ttl_config": {
      "properties": {
        "authorization": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "TTL for authorization decision cache.",
          "default": "60s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "jwt": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "TTL for validated JWT token cache.",
          "default": "300s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "jwks": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "TTL for JWKS (public keys) cache.",
          "default": "3600s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "check_config": {
      "properties": {
        "name": {
          "type": "string",
          "description": "Health check name (e.g. 'redis', 'opa')."
        },
        "enabled": {
          "type": "boolean",
          "description": "Enable this health check.",
          "default": true
        },
        "critical": {
          "type": "boolean",
          "description": "If true, failure marks service as unhealthy.",
          "default": false
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "circuit_breaker_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable circuit breaker for external service calls.",
          "default": true
        },
        "default": {
          "$ref": "#/$defs/circuit_breaker_settings",
          "description": "Default circuit breaker settings applied to all external calls."
        },
        "services": {
          "additionalProperties": {
            "$ref": "#/$defs/circuit_breaker_settings"
          },
          "type": "object",
          "description": "Per-service circuit breaker settings. Key is service name (e.g. 'opa', 'keycloak')."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "circuit_breaker_settings": {
      "properties": {
        "max_requests": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum requests allowed in half-open state before deciding to close or open.",
          "default": 3
        },
        "interval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Cyclic period for clearing failure counts when circuit is closed.",
          "default": "60s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Duration of open state before switching to half-open.",
          "default": "30s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "failure_threshold": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of consecutive failures before opening circuit.",
          "default": 5
        },
        "success_threshold": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of consecutive successes in half-open state to close circuit.",
          "default": 2
        },
        "on_state_change": {
          "type": "boolean",
          "description": "Log circuit breaker state changes.",
          "default": true
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "egress_auth_config": {
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "oauth2_client_credentials",
            "oauth2_refresh_token",
            "gcp_service_account",
            "aws_iam",
            "api_key",
            "mtls",
            "basic",
            "bearer"
          ],
          "description": "Authentication type for this target."
        },
        "token_url": {
          "type": "string",
          "description": "OAuth2 token endpoint URL. Used with oauth2_client_credentials and oauth2_refresh_token."
        },
        "client_id": {
          "type": "string",
          "description": "OAuth2 client ID."
        },
        "client_secret": {
          "type": "string",
          "description": "OAuth2 client secret. Consider using environment variable: AUTHZ_EGRESS_TARGETS_\u003cNAME\u003e_AUTH_CLIENT_SECRET."
        },
        "scopes": {
          "items": {
            "type": "string",
            "examples": [
              "read",
              "write"
            ]
          },
          "type": "array",
          "description": "OAuth2 scopes to request."
        },
        "refresh_token": {
          "type": "string",
          "description": "OAuth2 refresh token for oauth2_refresh_token type."
        },
        "refresh_before_expiry": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Refresh token this duration before expiry.",
          "default": "60s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "credentials_file": {
          "type": "string",
          "description": "Path to GCP service account JSON key file. Used with gcp_service_account type."
        },
        "role_arn": {
          "type": "string",
          "description": "AWS IAM role ARN to assume. Used with aws_iam type."
        },
        "region": {
          "type": "string",
          "description": "AWS region for IAM authentication.",
          "examples": [
            "us-east-1"
          ]
        },
        "header": {
          "type": "string",
          "description": "Header name for API key. Example: 'X-API-Key'. Used with api_key type."
        },
        "query_key": {
          "type": "string",
          "description": "Query parameter name for API key. Alternative to header."
        },
        "key": {
          "type": "string",
          "description": "The API key value. Consider using environment variable."
        },
        "username": {
          "type": "string",
          "description": "Username for basic authentication."
        },
        "password": {
          "type": "string",
          "description": "Password for basic authentication. Consider using environment variable."
        },
        "token": {
          "type": "string",
          "description": "Static bearer token. Consider using environment variable. Used with bearer type."
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "type"
      ]
    },
    "egress_defaults_config": {
      "properties": {
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Default request timeout for all targets.",
          "default": "30s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "retry": {
          "$ref": "#/$defs/egress_retry_config",
          "description": "Default retry configuration for all targets."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "egress_listener_config": {
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique listener name.",
          "x-runtime-updatable": false
        },
        "port": {
          "type": "integer",
          "description": "Listener port for this egress category.",
          "x-runtime-updatable": false,
          "x-runtime-update-note": "Port change requires restart"
        },
        "bind": {
          "type": "string",
          "description": "Bind address for the listener.",
          "default": "0.0.0.0",
          "x-runtime-updatable": false
        },
        "targets": {
          "additionalProperties": {
            "$ref": "#/$defs/egress_target_config"
          },
          "type": "object",
          "description": "External targets for this listener.",
          "x-runtime-updatable": true
        },
        "routes": {
          "items": {
            "$ref": "#/$defs/egress_route_config"
          },
          "type": "array",
          "description": "Routing rules mapping paths to targets.",
          "x-runtime-updatable": true
        },
        "default_target": {
          "type": "string",
          "description": "Default target when no route matches.",
          "x-runtime-updatable": true
        },
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Request timeout for this listener.",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ],
          "x-runtime-updatable": true
        },
        "retry": {
          "$ref": "#/$defs/egress_retry_config",
          "description": "Retry configuration for this listener.",
          "x-runtime-updatable": true
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "name",
        "port"
      ]
    },
    "egress_listeners_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable egress proxy mode globally.",
          "default": false,
          "x-runtime-updatable": true
        },
        "listeners": {
          "items": {
            "$ref": "#/$defs/egress_listener_config"
          },
          "type": "array",
          "description": "List of egress listener configurations. Each listener handles different external API categories.",
          "x-runtime-updatable": true,
          "x-runtime-update-note": "Adding new listeners may require port binding"
        },
        "defaults": {
          "$ref": "#/$defs/egress_defaults_config",
          "description": "Default settings for all egress listeners.",
          "x-runtime-updatable": true
        },
        "token_store": {
          "$ref": "#/$defs/egress_token_store_config",
          "description": "Token storage configuration.",
          "x-runtime-updatable": true
        },
        "legacy_endpoint": {
          "$ref": "#/$defs/legacy_egress_endpoint",
          "description": "Legacy egress endpoint on main server port for backward compatibility.",
          "x-runtime-updatable": true
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "egress_redis_config": {
      "properties": {
        "address": {
          "type": "string",
          "description": "Redis server address. Example: 'localhost:6379'."
        },
        "password": {
          "type": "string",
          "description": "Redis password. Consider using environment variable."
        },
        "db": {
          "type": "integer",
          "description": "Redis database number.",
          "default": 0
        },
        "key_prefix": {
          "type": "string",
          "description": "Prefix for token keys in Redis.",
          "default": "egress:tokens:"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "egress_retry_config": {
      "properties": {
        "max_attempts": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum number of retry attempts.",
          "default": 3
        },
        "initial_backoff": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Initial backoff delay.",
          "default": "100ms",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "max_backoff": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Maximum backoff delay.",
          "default": "2s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "egress_route_config": {
      "properties": {
        "path_prefix": {
          "type": "string",
          "description": "Match requests with path starting with this prefix. Example: '/external/partner-api'."
        },
        "target": {
          "type": "string",
          "description": "Name of the target from 'targets' map to route to."
        },
        "strip_prefix": {
          "type": "string",
          "description": "Remove this prefix from path before forwarding."
        },
        "rewrite_prefix": {
          "type": "string",
          "description": "Replace stripped prefix with this value."
        },
        "methods": {
          "items": {
            "type": "string"
          },
          "type": "array",
          "description": "Restrict to these HTTP methods. Empty means all methods."
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "path_prefix",
        "target"
      ]
    },
    "egress_tls_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable TLS for connections to this target.",
          "default": true
        },
        "insecure_skip_verify": {
          "type": "boolean",
          "description": "Skip server certificate verification. WARNING: Not recommended for production!",
          "default": false
        },
        "ca_cert": {
          "type": "string",
          "description": "Path to CA certificate for server verification."
        },
        "client_cert": {
          "type": "string",
          "description": "Path to client certificate for mTLS authentication."
        },
        "client_key": {
          "type": "string",
          "description": "Path to client private key for mTLS authentication."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "egress_target_config": {
      "properties": {
        "url": {
          "type": "string",
          "description": "Base URL of the external service. Example: 'https://api.partner.com'."
        },
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Request timeout for this target. Overrides defaults.timeout.",
          "default": "30s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "auth": {
          "$ref": "#/$defs/egress_auth_config",
          "description": "Authentication configuration for requests to this target."
        },
        "tls": {
          "$ref": "#/$defs/egress_tls_config",
          "description": "TLS configuration for secure connections to this target."
        },
        "retry": {
          "$ref": "#/$defs/egress_retry_config",
          "description": "Retry configuration for failed requests to this target."
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "url",
        "auth"
      ]
    },
    "egress_token_store_config": {
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "memory",
            "redis"
          ],
          "description": "Token storage backend type.",
          "default": "memory"
        },
        "redis": {
          "$ref": "#/$defs/egress_redis_config",
          "description": "Redis configuration (when type=redis)."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "enrich_config": {
      "properties": {
        "include_headers": {
          "items": {
            "type": "string",
            "examples": [
              "X-Request-ID",
              "X-Correlation-ID"
            ]
          },
          "type": "array",
          "description": "Request headers to include in audit logs."
        },
        "mask_fields": {
          "items": {
            "type": "string",
            "examples": [
              "password",
              "token"
            ]
          },
          "type": "array",
          "description": "Fields to mask in audit logs (for PII/sensitive data)."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "export_config": {
      "properties": {
        "otlp": {
          "$ref": "#/$defs/otlp_export_config",
          "description": "OpenTelemetry (OTLP) export configuration."
        },
        "stdout": {
          "$ref": "#/$defs/stdout_export_config",
          "description": "Stdout export configuration for local debugging."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "fallback_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable fallback policy when primary engine fails.",
          "default": true
        },
        "engine": {
          "type": "string",
          "enum": [
            "builtin",
            "opa_embedded"
          ],
          "description": "Fallback policy engine.",
          "default": "builtin"
        },
        "behavior": {
          "type": "string",
          "enum": [
            "deny",
            "allow"
          ],
          "description": "Default decision when fallback is used.",
          "default": "deny"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "HeadersSourceConfig": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable individual header extraction. Used as fallback when XFCC is not available.",
          "default": false
        },
        "subject": {
          "type": "string",
          "description": "Header name for certificate subject DN.",
          "default": "X-SSL-Client-S-DN"
        },
        "issuer": {
          "type": "string",
          "description": "Header name for certificate issuer DN.",
          "default": "X-SSL-Client-I-DN"
        },
        "common_name": {
          "type": "string",
          "description": "Header name for certificate common name (CN).",
          "default": "X-SSL-Client-CN"
        },
        "serial": {
          "type": "string",
          "description": "Header name for certificate serial number.",
          "default": "X-SSL-Client-Serial"
        },
        "verified": {
          "type": "string",
          "description": "Header name for certificate verification status.",
          "default": "X-SSL-Client-Verify"
        },
        "verified_value": {
          "type": "string",
          "description": "Value in verified header that indicates successful verification.",
          "default": "SUCCESS"
        },
        "fingerprint": {
          "type": "string",
          "description": "Header name for certificate SHA256 fingerprint.",
          "default": "X-SSL-Client-Fingerprint"
        },
        "dns_names": {
          "type": "string",
          "description": "Header name for SAN DNS names (comma-separated).",
          "default": "X-SSL-Client-DNS"
        },
        "uri": {
          "type": "string",
          "description": "Header name for SAN URIs including SPIFFE IDs (comma-separated).",
          "default": "X-SSL-Client-URI"
        },
        "not_before": {
          "type": "string",
          "description": "Header name for certificate not before timestamp.",
          "default": "X-SSL-Client-Not-Before"
        },
        "not_after": {
          "type": "string",
          "description": "Header name for certificate not after timestamp.",
          "default": "X-SSL-Client-Not-After"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "health_config": {
      "properties": {
        "check_interval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Interval between health checks.",
          "default": "10s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Timeout for individual health checks.",
          "default": "5s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "checks": {
          "items": {
            "$ref": "#/$defs/check_config"
          },
          "type": "array",
          "description": "Individual health check configurations."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "issuer_config": {
      "properties": {
        "name": {
          "type": "string",
          "description": "Friendly name for this issuer (used in logs and metrics)."
        },
        "issuer_url": {
          "type": "string",
          "description": "Expected 'iss' claim value. Must match exactly. Example: 'https://keycloak.example.com/realms/app'."
        },
        "jwks_url": {
          "type": "string",
          "description": "URL to fetch JWKS (public keys) for signature verification. Usually: {issuer_url}/.well-known/jwks.json or {issuer_url}/protocol/openid-connect/certs."
        },
        "audience": {
          "items": {
            "type": "string"
          },
          "type": "array",
          "description": "Expected 'aud' claim values. At least one must match if specified."
        },
        "algorithms": {
          "items": {
            "type": "string",
            "examples": [
              "RS256",
              "ES256"
            ]
          },
          "type": "array",
          "description": "Allowed signing algorithms. Restricts which algorithms are accepted."
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "issuer_url",
        "jwks_url"
      ]
    },
    "jwks_cache_config": {
      "properties": {
        "refresh_interval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Interval for background JWKS refresh.",
          "default": "1h",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "refresh_timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Timeout for JWKS fetch requests.",
          "default": "10s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "min_refresh_interval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Minimum interval between JWKS refreshes (rate limiting).",
          "default": "5m",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "jwt_config": {
      "properties": {
        "issuers": {
          "items": {
            "$ref": "#/$defs/issuer_config"
          },
          "type": "array",
          "description": "List of trusted JWT issuers. At least one issuer must be configured."
        },
        "jwks_cache": {
          "$ref": "#/$defs/jwks_cache_config",
          "description": "JWKS (JSON Web Key Set) caching configuration."
        },
        "validation": {
          "$ref": "#/$defs/validation_config",
          "description": "Token validation settings."
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "issuers"
      ]
    },
    "l1cache_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable in-memory L1 cache.",
          "default": true
        },
        "max_size": {
          "type": "integer",
          "description": "Maximum number of entries in L1 cache.",
          "default": 10000
        },
        "ttl": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Time-to-live for L1 cache entries.",
          "default": "10s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "l2cache_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable distributed L2 cache (Redis).",
          "default": false
        },
        "backend": {
          "type": "string",
          "enum": [
            "redis"
          ],
          "description": "L2 cache backend type.",
          "default": "redis"
        },
        "redis": {
          "$ref": "#/$defs/redis_cache_config",
          "description": "Redis configuration for L2 cache."
        },
        "ttl": {
          "$ref": "#/$defs/cache_ttl_config",
          "description": "TTL settings for different cache entry types."
        },
        "key_prefix": {
          "type": "string",
          "description": "Prefix for all cache keys in Redis.",
          "default": "authz:"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "legacy_egress_endpoint": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable legacy egress endpoint on main server port.",
          "default": true
        },
        "path": {
          "type": "string",
          "description": "Legacy egress endpoint path prefix.",
          "default": "/egress"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "opa_config": {
      "properties": {
        "url": {
          "type": "string",
          "description": "OPA server URL.",
          "default": "http://localhost:8181"
        },
        "policy_path": {
          "type": "string",
          "description": "OPA policy decision path.",
          "default": "/v1/data/authz/allow"
        },
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Request timeout for OPA queries.",
          "default": "10ms",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "retry": {
          "$ref": "#/$defs/retry_config",
          "description": "Retry configuration for OPA requests."
        },
        "tls": {
          "$ref": "#/$defs/OPATLSConfig",
          "description": "TLS configuration for OPA connection."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "opa_embedded_config": {
      "properties": {
        "bundle_path": {
          "type": "string",
          "description": "Path to OPA bundle file (tar.gz). Alternative to policy_dir."
        },
        "policy_dir": {
          "type": "string",
          "description": "Directory containing Rego policy files (.rego).",
          "default": "/etc/authz/policies"
        },
        "data_dir": {
          "type": "string",
          "description": "Directory containing JSON data files for OPA.",
          "default": "/etc/authz/data"
        },
        "decision_path": {
          "type": "string",
          "description": "Rego package path for authorization decision. Example: 'authz.allow' evaluates data.authz.allow.",
          "default": "authz.allow"
        },
        "hot_reload": {
          "type": "boolean",
          "description": "Enable automatic policy reload on file changes.",
          "default": true
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "OPATLSConfig": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable TLS for OPA connection.",
          "default": false
        },
        "ca_cert": {
          "type": "string",
          "description": "Path to CA certificate file for OPA server verification."
        },
        "client_cert": {
          "type": "string",
          "description": "Path to client certificate file for mTLS."
        },
        "client_key": {
          "type": "string",
          "description": "Path to client key file for mTLS."
        },
        "insecure_skip_verify": {
          "type": "boolean",
          "description": "Skip TLS certificate verification (INSECURE - use only for testing).",
          "default": false
        },
        "server_name": {
          "type": "string",
          "description": "Expected server name in OPA certificate for SNI verification."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "otlp_export_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable OTLP export to collectors like Jaeger, Tempo.",
          "default": false
        },
        "endpoint": {
          "type": "string",
          "description": "OTLP collector endpoint URL.",
          "examples": [
            "localhost:4317"
          ]
        },
        "insecure": {
          "type": "boolean",
          "description": "Use insecure (non-TLS) connection to collector.",
          "default": false
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "partial_mask_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable partial masking (show first/last characters).",
          "default": false
        },
        "show_first": {
          "type": "integer",
          "description": "Number of first characters to show.",
          "default": 4
        },
        "show_last": {
          "type": "integer",
          "description": "Number of last characters to show.",
          "default": 4
        },
        "min_length": {
          "type": "integer",
          "description": "Minimum value length for partial masking. Shorter values are fully masked.",
          "default": 12
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "policy_config": {
      "properties": {
        "engine": {
          "type": "string",
          "enum": [
            "builtin",
            "opa_sidecar",
            "opa_embedded"
          ],
          "description": "Policy engine type.",
          "default": "builtin"
        },
        "opa": {
          "$ref": "#/$defs/opa_config",
          "description": "OPA sidecar configuration (when engine=opa_sidecar)."
        },
        "opa_embedded": {
          "$ref": "#/$defs/opa_embedded_config",
          "description": "Embedded OPA configuration (when engine=opa_embedded)."
        },
        "builtin": {
          "$ref": "#/$defs/builtin_policy_config",
          "description": "Builtin YAML rules engine configuration (when engine=builtin)."
        },
        "fallback": {
          "$ref": "#/$defs/fallback_config",
          "description": "Fallback policy configuration when primary engine fails."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "proxy_defaults_config": {
      "properties": {
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Default request timeout.",
          "default": "30s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "idle_conn_timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Idle connection timeout.",
          "default": "90s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "max_idle_conns": {
          "type": "integer",
          "description": "Maximum idle connections per host.",
          "default": 100
        },
        "headers": {
          "$ref": "#/$defs/proxy_headers_config",
          "description": "Default header settings."
        },
        "retry": {
          "$ref": "#/$defs/proxy_retry_config",
          "description": "Default retry settings."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "proxy_headers_config": {
      "properties": {
        "add": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object",
          "description": "Headers to add to forwarded requests. Example: {'X-Forwarded-Proto': 'https'}."
        },
        "remove": {
          "items": {
            "type": "string"
          },
          "type": "array",
          "description": "Headers to remove from forwarded requests. Example: ['Authorization', 'Cookie']."
        },
        "forward": {
          "items": {
            "type": "string"
          },
          "type": "array",
          "description": "Headers to forward from original request (whitelist). Empty means forward all (except removed)."
        },
        "add_user_info": {
          "type": "boolean",
          "description": "Add user information headers (ID, roles) to forwarded requests.",
          "default": true
        },
        "user_id_header": {
          "type": "string",
          "description": "Header name for user ID (from JWT 'sub' claim).",
          "default": "X-User-ID"
        },
        "user_roles_header": {
          "type": "string",
          "description": "Header name for user roles (comma-separated).",
          "default": "X-User-Roles"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "proxy_listener_config": {
      "properties": {
        "name": {
          "type": "string",
          "description": "Unique listener name for identification.",
          "x-runtime-updatable": false
        },
        "port": {
          "type": "integer",
          "description": "Listener port. Can reference environment server ports or be a new dynamic port.",
          "x-runtime-updatable": false,
          "x-runtime-update-note": "Port change requires restart"
        },
        "bind": {
          "type": "string",
          "description": "Bind address for the listener.",
          "default": "0.0.0.0",
          "x-runtime-updatable": false
        },
        "mode": {
          "type": "string",
          "enum": [
            "reverse_proxy",
            "decision_only"
          ],
          "description": "Proxy operation mode.",
          "default": "reverse_proxy",
          "x-runtime-updatable": true
        },
        "upstreams": {
          "additionalProperties": {
            "$ref": "#/$defs/upstream_config"
          },
          "type": "object",
          "description": "Named upstream servers for this listener.",
          "x-runtime-updatable": true
        },
        "routes": {
          "items": {
            "$ref": "#/$defs/route_config"
          },
          "type": "array",
          "description": "Routing rules for this listener.",
          "x-runtime-updatable": true
        },
        "headers": {
          "$ref": "#/$defs/proxy_headers_config",
          "description": "Header manipulation for this listener.",
          "x-runtime-updatable": true
        },
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Request timeout for this listener.",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ],
          "x-runtime-updatable": true
        },
        "retry": {
          "$ref": "#/$defs/proxy_retry_config",
          "description": "Retry configuration for this listener.",
          "x-runtime-updatable": true
        },
        "require_auth": {
          "type": "boolean",
          "description": "Require authorization for all requests on this listener.",
          "default": true,
          "x-runtime-updatable": true
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "name"
      ]
    },
    "proxy_listeners_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable reverse proxy mode globally.",
          "default": false,
          "x-runtime-updatable": true
        },
        "listeners": {
          "items": {
            "$ref": "#/$defs/proxy_listener_config"
          },
          "type": "array",
          "description": "List of proxy listener configurations. Each listener runs on a separate port.",
          "x-runtime-updatable": true,
          "x-runtime-update-note": "Adding new listeners may require port binding"
        },
        "defaults": {
          "$ref": "#/$defs/proxy_defaults_config",
          "description": "Default settings applied to all proxy listeners.",
          "x-runtime-updatable": true
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "proxy_retry_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable automatic retry for failed upstream requests.",
          "default": true
        },
        "max_attempts": {
          "type": "integer",
          "maximum": 10,
          "minimum": 1,
          "description": "Maximum number of retry attempts.",
          "default": 3
        },
        "initial_backoff": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Initial backoff delay before first retry.",
          "default": "100ms",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "max_backoff": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Maximum backoff delay between retries.",
          "default": "1s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "retry_on": {
          "items": {
            "type": "integer"
          },
          "type": "array",
          "description": "HTTP status codes that trigger retry.",
          "default": [
            "[502,503,504]"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "rate_limit_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable rate limiting for incoming requests.",
          "default": true
        },
        "rate": {
          "type": "string",
          "description": "Rate limit in format 'requests-period'. Periods: S (second), M (minute), H (hour), D (day). Example: '100-S' = 100 req/sec, '1000-M' = 1000 req/min.",
          "default": "100-S"
        },
        "store": {
          "type": "string",
          "enum": [
            "memory",
            "redis"
          ],
          "description": "Rate limit storage backend.",
          "default": "memory"
        },
        "redis": {
          "$ref": "#/$defs/RateLimitRedisConfig",
          "description": "Redis configuration for distributed rate limiting (when store=redis)."
        },
        "trust_forwarded_for": {
          "type": "boolean",
          "description": "Trust X-Forwarded-For header for client IP identification. Enable when behind proxy/load balancer.",
          "default": true
        },
        "exclude_paths": {
          "items": {
            "type": "string",
            "examples": [
              "/health",
              "/metrics",
              "/ready"
            ]
          },
          "type": "array",
          "description": "Paths to exclude from rate limiting. Supports glob patterns."
        },
        "by_endpoint": {
          "type": "boolean",
          "description": "Apply rate limits per endpoint instead of globally.",
          "default": false
        },
        "endpoint_rates": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object",
          "description": "Per-endpoint rate limits. Key is path prefix, value is rate. Example: {'/v1/authorize': '1000-S', '/v1/token': '100-S'}."
        },
        "headers": {
          "$ref": "#/$defs/rate_limit_headers_config",
          "description": "Rate limit response headers configuration."
        },
        "fail_close": {
          "type": "boolean",
          "description": "Deny requests when rate limiter encounters an error. True = fail-close (secure), False = fail-open (available). Recommended: true for authorization services.",
          "default": true
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "rate_limit_headers_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Include rate limit headers in HTTP response (X-RateLimit-*).",
          "default": true
        },
        "limit_header": {
          "type": "string",
          "description": "Header name for rate limit value.",
          "default": "X-RateLimit-Limit"
        },
        "remaining_header": {
          "type": "string",
          "description": "Header name for remaining requests.",
          "default": "X-RateLimit-Remaining"
        },
        "reset_header": {
          "type": "string",
          "description": "Header name for reset timestamp.",
          "default": "X-RateLimit-Reset"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "RateLimitRedisConfig": {
      "properties": {
        "address": {
          "type": "string",
          "description": "Redis server address.",
          "examples": [
            "localhost:6379"
          ]
        },
        "password": {
          "type": "string",
          "description": "Redis password. Consider using environment variable AUTHZ_RESILIENCE_RATE_LIMIT_REDIS_PASSWORD."
        },
        "db": {
          "type": "integer",
          "description": "Redis database number.",
          "default": 1
        },
        "key_prefix": {
          "type": "string",
          "description": "Prefix for rate limit keys in Redis.",
          "default": "authz:ratelimit:"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "redis_cache_config": {
      "properties": {
        "addresses": {
          "items": {
            "type": "string",
            "examples": [
              "localhost:6379"
            ]
          },
          "type": "array",
          "description": "Redis server addresses. Multiple for cluster mode."
        },
        "password": {
          "type": "string",
          "description": "Redis password. Consider using environment variable."
        },
        "db": {
          "type": "integer",
          "description": "Redis database number.",
          "default": 0
        },
        "pool_size": {
          "type": "integer",
          "description": "Connection pool size per address.",
          "default": 10
        },
        "read_timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Timeout for read operations.",
          "default": "3s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "write_timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Timeout for write operations.",
          "default": "3s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "request_body_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable request body access in CEL expressions. WARNING: This feature has security and performance implications. Body is buffered in memory and requires JSON validation.",
          "default": false
        },
        "max_size": {
          "type": "integer",
          "maximum": 10485760,
          "minimum": 1024,
          "description": "Maximum request body size in bytes. Bodies larger than this will be rejected with 413 Payload Too Large.",
          "default": 1048576
        },
        "allowed_content_types": {
          "items": {
            "type": "string",
            "examples": [
              "application/json"
            ]
          },
          "type": "array",
          "description": "Content types allowed for body access. Empty defaults to application/json only."
        },
        "require_content_type": {
          "type": "boolean",
          "description": "Require Content-Type header for body parsing. When true, requests without Content-Type are rejected.",
          "default": true
        },
        "schema": {
          "$ref": "#/$defs/request_body_schema_config",
          "description": "JSON Schema validation configuration for request bodies."
        },
        "methods": {
          "items": {
            "type": "string",
            "examples": [
              "POST",
              "PUT",
              "PATCH"
            ]
          },
          "type": "array",
          "description": "HTTP methods for which body access is enabled. Empty defaults to POST, PUT, PATCH."
        },
        "paths": {
          "items": {
            "type": "string",
            "examples": [
              "/api/v1/**"
            ]
          },
          "type": "array",
          "description": "Path patterns (glob) for which body access is enabled. Empty means all paths."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "request_body_schema_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable JSON Schema validation for request bodies.",
          "default": false
        },
        "schema_dir": {
          "type": "string",
          "description": "Directory containing JSON Schema files. Schema lookup: path + method -\u003e {schema_dir}/{path}/{method}.json",
          "default": "/etc/authz/schemas"
        },
        "strict_validation": {
          "type": "boolean",
          "description": "Fail requests without matching schema. When false, requests without schema pass validation.",
          "default": false
        },
        "allow_additional_properties": {
          "type": "boolean",
          "description": "Allow properties not defined in schema. Maps to JSON Schema additionalProperties.",
          "default": true
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "resilience_config": {
      "properties": {
        "rate_limit": {
          "$ref": "#/$defs/rate_limit_config",
          "description": "Rate limiting configuration for incoming HTTP requests. Protects service from overload."
        },
        "circuit_breaker": {
          "$ref": "#/$defs/circuit_breaker_config",
          "description": "Circuit breaker configuration for external service calls. Prevents cascade failures."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "retry_config": {
      "properties": {
        "max_attempts": {
          "type": "integer",
          "description": "Maximum retry attempts.",
          "default": 3
        },
        "initial_backoff": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Initial backoff delay.",
          "default": "1ms",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "max_backoff": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Maximum backoff delay.",
          "default": "10ms",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "route_config": {
      "properties": {
        "path_prefix": {
          "type": "string",
          "description": "Match requests where path starts with this prefix. Example: '/api/v1'."
        },
        "path_exact": {
          "type": "string",
          "description": "Match requests with exactly this path. Example: '/health'."
        },
        "path_regex": {
          "type": "string",
          "description": "Match requests using regex pattern. Example: '^/api/v[0-9]+/.*$'."
        },
        "methods": {
          "items": {
            "type": "string",
            "examples": [
              "GET",
              "POST"
            ]
          },
          "type": "array",
          "description": "HTTP methods to match. Empty means all methods."
        },
        "headers": {
          "additionalProperties": {
            "type": "string"
          },
          "type": "object",
          "description": "Request headers to match (exact values). Example: {'X-Tenant': 'acme'}."
        },
        "upstream": {
          "type": "string",
          "description": "Name of the target upstream from 'upstreams' map."
        },
        "rewrite_prefix": {
          "type": "string",
          "description": "Replace matched prefix with this value. Used with strip_prefix."
        },
        "strip_prefix": {
          "type": "string",
          "description": "Remove this prefix from path before forwarding. Example: '/api' strips '/api/users' to '/users'."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "sensitive_data_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable automatic masking of sensitive data in logs.",
          "default": true
        },
        "mask_value": {
          "type": "string",
          "description": "Value to replace sensitive data with.",
          "default": "***MASKED***"
        },
        "fields": {
          "items": {
            "type": "string"
          },
          "type": "array",
          "description": "Field names to mask in logs (case-insensitive). Applied to JSON keys and struct fields.",
          "default": [
            "[password,secret,token,api_key,apikey,authorization,client_secret,access_token,refresh_token,private_key,credential]"
          ]
        },
        "headers": {
          "items": {
            "type": "string"
          },
          "type": "array",
          "description": "HTTP header names to mask in logs (case-insensitive).",
          "default": [
            "[Authorization,X-API-Key,Cookie,Set-Cookie]"
          ]
        },
        "mask_jwt": {
          "type": "boolean",
          "description": "Mask JWT token payload in logs (keeps header and signature indicator visible).",
          "default": true
        },
        "partial_mask": {
          "$ref": "#/$defs/partial_mask_config",
          "description": "Partial masking configuration to show parts of sensitive values."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "services_config": {
      "properties": {
        "version": {
          "type": "string",
          "description": "Configuration version for change tracking.",
          "x-runtime-updatable": true
        },
        "jwt": {
          "$ref": "#/$defs/jwt_config",
          "description": "JWT token validation configuration.",
          "x-runtime-updatable": true
        },
        "token_exchange": {
          "$ref": "#/$defs/token_exchange_config",
          "description": "OAuth2 Token Exchange configuration.",
          "x-runtime-updatable": true
        },
        "policy": {
          "$ref": "#/$defs/policy_config",
          "description": "Policy engine configuration.",
          "x-runtime-updatable": true
        },
        "cache": {
          "$ref": "#/$defs/cache_config",
          "description": "Caching configuration.",
          "x-runtime-updatable": true
        },
        "audit": {
          "$ref": "#/$defs/audit_config",
          "description": "Audit logging configuration.",
          "x-runtime-updatable": true
        },
        "health": {
          "$ref": "#/$defs/health_config",
          "description": "Health check configuration.",
          "x-runtime-updatable": true
        },
        "resilience": {
          "$ref": "#/$defs/resilience_config",
          "description": "Resilience patterns configuration.",
          "x-runtime-updatable": true
        },
        "sensitive_data": {
          "$ref": "#/$defs/sensitive_data_config",
          "description": "Sensitive data handling configuration.",
          "x-runtime-updatable": true
        },
        "tls_client_cert": {
          "$ref": "#/$defs/tls_client_cert_config",
          "description": "TLS client certificate configuration.",
          "x-runtime-updatable": true
        },
        "request_body": {
          "$ref": "#/$defs/request_body_config",
          "description": "Request body access configuration.",
          "x-runtime-updatable": true
        },
        "proxy": {
          "$ref": "#/$defs/proxy_listeners_config",
          "description": "Reverse proxy listeners configuration.",
          "x-runtime-updatable": true
        },
        "egress": {
          "$ref": "#/$defs/egress_listeners_config",
          "description": "Egress proxy listeners configuration.",
          "x-runtime-updatable": true
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "stdout_export_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable audit log output to stdout.",
          "default": true
        },
        "format": {
          "type": "string",
          "enum": [
            "json",
            "text"
          ],
          "description": "Output format for stdout audit logs.",
          "default": "json"
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "tls_client_cert_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable client certificate extraction for mTLS/SPIFFE identity. When enabled, certificate info is available in CEL as 'tls' variable.",
          "default": false
        },
        "sources": {
          "$ref": "#/$defs/TLSSourcesConfig",
          "description": "Certificate information sources. Multiple sources can be enabled and will be used in cascade (XFCC first, then headers)."
        },
        "trusted_spiffe_domains": {
          "items": {
            "type": "string",
            "examples": [
              "cluster.local",
              "prod.example.com"
            ]
          },
          "type": "array",
          "description": "List of trusted SPIFFE trust domains. If specified, only certificates with matching trust domains are accepted."
        },
        "trusted_proxy_cid_rs": {
          "items": {
            "type": "string",
            "examples": [
              "10.0.0.0/8",
              "172.16.0.0/12"
            ]
          },
          "type": "array",
          "description": "CIDR ranges of trusted proxies for XFCC header. Only accept XFCC from these sources to prevent header injection."
        },
        "require_verified": {
          "type": "boolean",
          "description": "Require client certificate to be verified. When true, requests without verified certificates are rejected.",
          "default": false
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "TLSSourcesConfig": {
      "properties": {
        "xfcc": {
          "$ref": "#/$defs/XFCCSourceConfig",
          "description": "X-Forwarded-Client-Cert (XFCC) header configuration. This is the standard header used by Envoy/Istio for passing client certificate information."
        },
        "headers": {
          "$ref": "#/$defs/HeadersSourceConfig",
          "description": "Individual headers configuration for extracting certificate fields. Used by Nginx, HAProxy, and other reverse proxies."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "token_exchange_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable OAuth2 Token Exchange (RFC 8693).",
          "default": false
        },
        "token_url": {
          "type": "string",
          "description": "Token endpoint URL for exchange requests."
        },
        "client_id": {
          "type": "string",
          "description": "OAuth2 client ID for token exchange."
        },
        "client_secret": {
          "type": "string",
          "description": "OAuth2 client secret. Consider using environment variable."
        },
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Timeout for token exchange requests.",
          "default": "10s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "upstream_config": {
      "properties": {
        "url": {
          "type": "string",
          "description": "Base URL of the upstream server. Example: 'http://backend:8080' or 'https://api.internal.local'."
        },
        "tls": {
          "$ref": "#/$defs/upstream_tls_config",
          "description": "TLS configuration for secure upstream connections."
        },
        "health_check": {
          "$ref": "#/$defs/upstream_health_config",
          "description": "Health check configuration for upstream availability monitoring."
        }
      },
      "additionalProperties": false,
      "type": "object",
      "required": [
        "url"
      ]
    },
    "upstream_health_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable periodic health checks for this upstream.",
          "default": false
        },
        "path": {
          "type": "string",
          "description": "HTTP path for health check requests.",
          "default": "/health"
        },
        "interval": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Interval between health check requests.",
          "default": "10s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "timeout": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Timeout for health check requests.",
          "default": "5s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "upstream_tls_config": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable TLS for upstream connections.",
          "default": false
        },
        "insecure_skip_verify": {
          "type": "boolean",
          "description": "Skip server certificate verification. WARNING: Not recommended for production!",
          "default": false
        },
        "ca_cert": {
          "type": "string",
          "description": "Path to CA certificate file for server verification. Required for self-signed certificates."
        },
        "client_cert": {
          "type": "string",
          "description": "Path to client certificate for mutual TLS (mTLS) authentication."
        },
        "client_key": {
          "type": "string",
          "description": "Path to client private key for mutual TLS (mTLS) authentication."
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "validation_config": {
      "properties": {
        "clock_skew": {
          "type": "string",
          "pattern": "^([0-9]+(\\.[0-9]+)?(ns|us|µs|ms|s|m|h))+$",
          "description": "Allowed clock skew for exp/nbf/iat validation. Compensates for server time differences.",
          "default": "30s",
          "examples": [
            "10s",
            "5m",
            "1h",
            "30s"
          ]
        },
        "require_expiration": {
          "type": "boolean",
          "description": "Require 'exp' claim in tokens. Recommended for security.",
          "default": true
        },
        "require_not_before": {
          "type": "boolean",
          "description": "Require 'nbf' claim in tokens.",
          "default": false
        }
      },
      "additionalProperties": false,
      "type": "object"
    },
    "XFCCSourceConfig": {
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable XFCC header parsing. This is the primary source when using Envoy/Istio.",
          "default": true
        },
        "header": {
          "type": "string",
          "description": "XFCC header name.",
          "default": "X-Forwarded-Client-Cert"
        }
      },
      "additionalProperties": false,
      "type": "object"
    }
  },
  "title": "Authz Service Services Configuration",
  "description": "Dynamic services configuration that can be updated at runtime without restart.\n\nThis configuration includes JWT, policy, cache, proxy, egress, and other service settings.\nProperties marked with x-runtime-updatable: true can be changed without restart.",
  "x-runtime-updatable": true
}
