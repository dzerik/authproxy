apiVersion: v1
kind: ConfigMap
metadata:
  name: authz-config
  labels:
    app: authz-service
data:
  jwt.issuer_url: "http://keycloak.default.svc.cluster.local:8080/realms/master"
  cache.l2.enabled: "false"
  cache.l2.redis.address: "redis.default.svc.cluster.local:6379"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: authz-rules
  labels:
    app: authz-service
data:
  rules.yaml: |
    version: "v1.0.0"
    description: "Authorization rules"
    default_deny: true

    rules:
      # Health and metrics endpoints
      - name: allow-health-endpoints
        description: "Allow access to health check endpoints"
        priority: 1000
        enabled: true
        conditions:
          paths:
            - "/health"
            - "/health/*"
            - "/healthz"
            - "/ready"
            - "/readyz"
            - "/live"
            - "/livez"
          methods:
            - GET
        effect: allow

      - name: allow-metrics
        description: "Allow access to metrics endpoint"
        priority: 999
        enabled: true
        conditions:
          paths:
            - "/metrics"
          methods:
            - GET
        effect: allow

      # API authorization
      - name: api-admin-access
        description: "Allow admin role full API access"
        priority: 100
        enabled: true
        conditions:
          paths:
            - "/api/*"
          roles:
            - admin
            - realm-admin
        effect: allow

      - name: api-user-read-access
        description: "Allow users read access"
        priority: 90
        enabled: true
        conditions:
          paths:
            - "/api/v1/*"
          methods:
            - GET
          roles:
            - user
        effect: allow

      # Deny all other API requests
      - name: deny-unauthenticated-api
        description: "Deny access to API without valid authentication"
        priority: 1
        enabled: true
        conditions:
          paths:
            - "/api/*"
        effect: deny
