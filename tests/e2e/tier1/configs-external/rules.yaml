# Authorization Rules for Tier 1 External Partner authz-service
# Named rule sets for partner access

version: "v1.0.0"
description: "External partner authorization rules"
default_deny: true

# Named rule sets
rule_sets:
  # Partner access rules
  partner-rules:
    - name: public-health
      description: "Allow health endpoints"
      priority: 1000
      enabled: true
      conditions:
        paths:
          - "/health"
          - "/health/*"
        methods:
          - GET
      effect: allow

    - name: public-metrics
      description: "Allow metrics endpoint"
      priority: 999
      enabled: true
      conditions:
        paths:
          - "/metrics"
        methods:
          - GET
      effect: allow

    - name: partner-resources-list
      description: "Allow listing partner resources"
      priority: 500
      enabled: true
      conditions:
        paths:
          - "/partner/api/resources"
        methods:
          - GET
        roles:
          - external
          - service
      effect: allow

    - name: partner-resources-create
      description: "Allow creating partner resources"
      priority: 499
      enabled: true
      conditions:
        paths:
          - "/partner/api/resources"
        methods:
          - POST
        roles:
          - external
      effect: allow

    - name: partner-resources-read
      description: "Allow reading partner resources"
      priority: 498
      enabled: true
      conditions:
        paths:
          - "/partner/api/resources/*"
        methods:
          - GET
        roles:
          - external
          - service
      effect: allow

    - name: partner-actions
      description: "Allow partner actions"
      priority: 497
      enabled: true
      conditions:
        paths:
          - "/partner/api/actions/*"
        methods:
          - POST
        roles:
          - external
      effect: allow

    - name: partner-quotas
      description: "Allow checking quotas"
      priority: 496
      enabled: true
      conditions:
        paths:
          - "/partner/api/quotas"
        methods:
          - GET
        roles:
          - external
          - service
      effect: allow

    - name: partner-webhooks
      description: "Allow webhook notifications"
      priority: 494
      enabled: true
      conditions:
        paths:
          - "/partner/api/webhooks/*"
        methods:
          - POST
        roles:
          - external
          - service
      effect: allow

  # Internal service rules
  internal-service-rules:
    - name: internal-validate
      description: "Allow internal validation"
      priority: 600
      enabled: true
      conditions:
        paths:
          - "/internal/validate"
          - "/internal/validate/*"
        methods:
          - POST
        roles:
          - service
      effect: allow

  # Mock services rules (WireMock stubs for testing)
  mock-rules:
    - name: mock-user-access
      description: "Access to User mock service"
      priority: 700
      enabled: true
      conditions:
        paths:
          - "/mock/user/**"
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        roles:
          - admin
          - user
          - developer
          - viewer
          - service
      effect: allow

    - name: mock-admin-access
      description: "Access to Admin mock service"
      priority: 699
      enabled: true
      conditions:
        paths:
          - "/mock/admin/**"
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        roles:
          - admin
          - developer
          - service
      effect: allow

    - name: mock-external-access
      description: "Access to External mock service"
      priority: 698
      enabled: true
      conditions:
        paths:
          - "/mock/external/**"
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        roles:
          - admin
          - external
          - service
      effect: allow

  # Agent delegation rules
  delegated-agent-rules:
    - name: delegated-read
      description: "Allow delegated read access"
      priority: 400
      enabled: true
      conditions:
        paths:
          - "/partner/api/*"
        methods:
          - GET
        roles:
          - agent
      effect: allow

    - name: delegated-write
      description: "Allow delegated write access"
      priority: 399
      enabled: true
      conditions:
        paths:
          - "/partner/api/*"
        methods:
          - POST
          - PUT
        roles:
          - agent
      effect: allow

# Global rules (applied to all requests)
rules:
  # Health endpoints - highest priority
  - name: public-health
    description: "Allow health endpoints"
    priority: 1000
    enabled: true
    conditions:
      paths:
        - "/health"
        - "/health/*"
        - "/healthz"
        - "/ready"
        - "/live"
      methods:
        - GET
    effect: allow

  - name: public-metrics
    description: "Allow metrics endpoint"
    priority: 999
    enabled: true
    conditions:
      paths:
        - "/metrics"
      methods:
        - GET
    effect: allow

  # API rules for testing
  - name: api-users-admin
    description: "Admins can list users"
    priority: 100
    enabled: true
    conditions:
      paths:
        - "/api/v1/users"
      methods:
        - GET
      roles:
        - admin
    effect: allow

  - name: api-users-manage
    description: "Admins can manage users"
    priority: 99
    enabled: true
    conditions:
      paths:
        - "/api/v1/users/*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
      roles:
        - admin
    effect: allow

  - name: api-users-me-read
    description: "Users can read their profile"
    priority: 98
    enabled: true
    conditions:
      paths:
        - "/api/v1/users/me"
      methods:
        - GET
      roles:
        - user
        - admin
        - developer
    effect: allow

  - name: api-users-me-write
    description: "Users can update their profile"
    priority: 97
    enabled: true
    conditions:
      paths:
        - "/api/v1/users/me"
      methods:
        - PUT
        - PATCH
      roles:
        - user
        - admin
        - developer
    effect: allow

  - name: api-v1-read
    description: "Viewers can read API"
    priority: 50
    enabled: true
    conditions:
      paths:
        - "/api/v1/*"
      methods:
        - GET
      roles:
        - viewer
    effect: allow

  - name: api-v1-write
    description: "Admins and developers can write to API"
    priority: 49
    enabled: true
    conditions:
      paths:
        - "/api/v1/*"
      methods:
        - POST
        - PUT
        - PATCH
        - DELETE
      roles:
        - admin
        - developer
        - service
    effect: allow

  - name: admin-access
    description: "Admins can access admin endpoints"
    priority: 80
    enabled: true
    conditions:
      paths:
        - "/admin/*"
      roles:
        - admin
    effect: allow

  # Mock services access
  - name: mock-user-access
    description: "Access to User mock service"
    priority: 700
    enabled: true
    conditions:
      paths:
        - "/mock/user/**"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
      roles:
        - admin
        - user
        - developer
        - viewer
        - service
    effect: allow

  - name: mock-admin-access
    description: "Access to Admin mock service"
    priority: 699
    enabled: true
    conditions:
      paths:
        - "/mock/admin/**"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
      roles:
        - admin
        - developer
        - service
    effect: allow

  - name: mock-external-access
    description: "Access to External mock service"
    priority: 698
    enabled: true
    conditions:
      paths:
        - "/mock/external/**"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
      roles:
        - admin
        - external
        - service
    effect: allow

  # Deny unauthenticated partner access
  - name: deny-unauthenticated
    description: "Deny unauthenticated access"
    priority: 1
    enabled: true
    conditions:
      paths:
        - "/partner/*"
    effect: deny
