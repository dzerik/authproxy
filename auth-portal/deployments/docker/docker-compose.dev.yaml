version: '3.8'

# Development override for docker-compose.yaml
# Usage: docker-compose -f docker-compose.yaml -f docker-compose.dev.yaml up

services:
  auth-portal:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile
      target: builder  # Use builder stage for dev
    volumes:
      # Mount source code for hot reload
      - ../..:/build:cached
      # Mount configs
      - ../../configs:/app/configs:ro
    environment:
      - TZ=UTC
      - AUTH_PORTAL_CONFIG=/app/configs/auth-portal.yaml
      # Dev mode enabled
      - DEV_MODE=true
      # Use in-memory session (no Redis required)
      - SESSION_STORE=cookie
      # Dummy secrets for dev
      - SESSION_SECRET=dev-session-secret-32-bytes-long
      - ENCRYPTION_KEY=abcdefghijklmnopqrstuvwxyz!@#$%^
    ports:
      - "80:80"
      - "8081:8081"  # Expose Go backend directly for debugging
    command: >
      sh -c "
        cd /build &&
        go run ./cmd/auth-portal -dev
      "
    # Override healthcheck for dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    depends_on: []  # No dependencies in dev mode

  # Keycloak for local testing (optional, can use dev_mode instead)
  keycloak:
    profiles:
      - with-keycloak
    environment:
      - KC_LOG_LEVEL=INFO

  # PostgreSQL (only if keycloak is enabled)
  postgres:
    profiles:
      - with-keycloak

  # Redis is optional in dev
  redis:
    profiles:
      - redis
